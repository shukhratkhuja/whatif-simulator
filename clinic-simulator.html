<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Симулятор Socials - Final (Bed Days)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f5f7fa; color: #2d3748; line-height: 1.6; }
        
        /* Layout */
        .container { max-width: 1920px; margin: 0 auto; padding: 20px 40px; }
        .header { background: white; padding: 20px 40px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .header h1 { font-size: 24px; margin-bottom: 15px; color: #1a202c; }
        .main-layout { display: grid; grid-template-columns: 35% 65%; gap: 30px; align-items: start; }
        
        /* Form Elements */
        .form-section { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .form-block { margin-bottom: 25px; border-bottom: 1px solid #edf2f7; padding-bottom: 20px; }
        .form-block:last-child { border-bottom: none; }
        .form-block h3 { font-size: 16px; margin-bottom: 15px; font-weight: 700; color: #2d3748; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; color: #4a5568; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 8px 10px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 14px; }
        .two-col { display: flex; gap: 15px; }
        .two-col .col, .two-col .form-group { flex: 1; }

        .btn { width: 100%; padding: 12px; background: #4299e1; color: white; border: none; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn:hover { background: #3182ce; }

        /* Results & Metrics */
        .results-section { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .metric-group { margin-bottom: 30px; }
        .metric-group h2 { font-size: 18px; color: #1a202c; margin-bottom: 15px; padding: 10px; background: #edf2f7; border-radius: 4px; }
        
        .metric-card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .metric-card h3 { font-size: 15px; margin-bottom: 15px; color: #2d3748; font-weight: 700; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; }
        
        .metric-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 14px; border-bottom: 1px dashed #f0f0f0; }
        .metric-row:last-child { border-bottom: none; }
        .metric-label { color: #4a5568; }
        .metric-value { font-weight: 600; color: #2d3748; }

        /* Status Indicators */
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
        .status-low { background: #4299e1; } 
        .status-optimal { background: #48bb78; } 
        .status-high { background: #ecc94b; } 
        .status-critical { background: #f56565; }

        /* Lists & Tables */
        .detail-list { list-style: none; margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 6px; font-size: 13px; }
        .detail-list li { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .sub-list { margin-left: 15px; padding-left: 10px; border-left: 2px solid #e2e8f0; margin-top: 5px; margin-bottom: 10px; }
        .sub-list li { color: #718096; font-size: 12px; margin-bottom: 3px; }
        
        .resource-table { width: 100%; font-size: 13px; border-collapse: collapse; margin-top: 10px; }
        .resource-table th { text-align: left; background: #f7fafc; padding: 8px; font-weight: 600; border-bottom: 2px solid #edf2f7; }
        .resource-table td { padding: 8px; border-bottom: 1px solid #edf2f7; }
        .deficit { color: #e53e3e; font-weight: 700; }
        .surplus { color: #38a169; }

        .formula-hint { font-size: 11px; color: #718096; margin-top: 4px; font-family: monospace; background: #fefefe; padding: 4px; border: 1px solid #eee; border-radius: 4px; word-break: break-all; }
        .formula-block { margin-bottom: 10px; }

        .scenario-tabs { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
        .tab { padding: 8px 16px; background: #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 14px; user-select: none; }
        .tab:hover { background: #cbd5e0; }
        .tab.active { background: white; border: 1px solid #cbd5e0; border-bottom: 3px solid #4299e1; font-weight: 600; }
        .tab.compare-tab { background: #feebc8; }
        .tab.compare-tab.active { border-bottom: 3px solid #ecc94b; background: #fff; }
        
        .hidden { display: none; }
        
        /* Comparison Table */
        .comparison-view { background: white; padding: 30px; border-radius: 8px; }
        .comparison-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 20px; }
        .comparison-table th, .comparison-table td { padding: 12px; border: 1px solid #e2e8f0; text-align: left; }
        .comparison-table th { background: #f7fafc; font-weight: 600; }
        .group-header { background: #edf2f7 !important; font-weight: 700; text-align: center; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Симулятор Socials - Final (Bed Days)</h1>
        <div class="scenario-tabs" id="scenarioTabs"></div>
    </div>

    <div class="container">
        <div id="mainView" class="main-layout">
            <div class="form-section">
                <form id="clinicForm" onsubmit="return false;">
                    
                    <div class="form-block">
                        <h3>1. Визиты (Спрос)</h3>
                        <div class="form-group"><label>Визитов в год (Total)</label><input type="number" name="total_visits_per_year" value="800000"></div>
                        <div class="form-group"><label>Коэф. посещаемости</label><input type="number" name="visit_coefficient" value="3.5" step="0.1"></div>
                    </div>

                    <div class="form-block">
                        <h3>2. Ресурсы (Врачи)</h3>
                        <div class="form-group"><label>Количество врачей</label><input type="number" name="doctors" value="380"></div>
                        <div class="form-group"><label>Эффективное время работы, %</label><input type="number" name="doctor_efficiency" value="85"></div>
                        <div class="two-col">
                            <div class="form-group"><label>Операционные</label><input type="number" name="operating_rooms" value="20"></div>
                            <div class="form-group"><label>Койки</label><input type="number" name="beds" value="500"></div>
                        </div>
                        <div class="two-col">
                            <div class="form-group"><label>Медсестры</label><input type="number" name="nurses" value="400"></div>
                            <div class="form-group"><label>Администраторы</label><input type="number" name="admins" value="80"></div>
                        </div>
                        <div class="form-group"><label>Сервисный персонал</label><input type="number" name="service_staff" value="180"></div>
                    </div>

                    <div class="form-block">
                        <h3>3. График и Время</h3>
                        <div class="two-col">
                            <div class="form-group"><label>Дней/нед</label><select name="days_per_week"><option value="5">5</option><option value="6" selected>6</option><option value="7">7</option></select></div>
                            <div class="form-group"><label>Часов/смену</label><input type="number" name="hours_per_day" value="8"></div>
                        </div>
                        <div class="form-group"><label>Недель в году</label><input type="number" name="weeks_per_year" value="50"></div>
                        <div class="two-col">
                            <div class="form-group"><label>Время приема (мин)</label><input type="number" name="consultation_time" value="30"></div>
                            <div class="form-group"><label>Пересменка (мин)</label><input type="number" name="visit_prep_time" value="5"></div>
                        </div>
                         <div class="two-col">
                            <div class="form-group"><label>Время операции (мин)</label><input type="number" name="operation_time" value="90"></div>
                            <div class="form-group"><label>Подготовка Опер (мин)</label><input type="number" name="or_prep_time" value="30"></div>
                        </div>
                    </div>

                    <div class="form-block">
                        <h3>4. Финансы (Цены и Конверсии)</h3>
                        <div class="two-col">
                            <div class="form-group"><label>Чек Приема ($)</label><input type="number" name="consultation_price" value="33"></div>
                            <div class="form-group"><label>Чек Повторного ($)</label><input type="number" name="followup_price" value="33"></div>
                        </div>
                        <div class="two-col">
                            <div class="form-group"><label>Чек Операции ($)</label><input type="number" name="operation_price" value="1200"></div>
                            <div class="form-group"><label>Конверсия в опер (%)</label><input type="number" name="conversion_rate" value="5"></div>
                        </div>
                        <div class="two-col">
                            <div class="form-group"><label>Чек Диагностики ($)</label><input type="number" name="diagnostics_price" value="40"></div>
                            <div class="form-group"><label>Доля Диагностики (%)</label><input type="number" name="diagnostics_rate" value="50"></div>
                        </div>
                    </div>

                    <div class="form-block">
                        <h3>5. Расходы (Зарплаты и Мат.)</h3>
                        <div class="two-col">
                            <div class="form-group"><label>ЗП Врача (год)</label><input type="number" name="doctor_salary" value="24000"></div>
                            <div class="form-group"><label>ЗП Медсестры</label><input type="number" name="nurse_salary" value="6000"></div>
                        </div>
                        <div class="two-col">
                            <div class="form-group"><label>ЗП Админа</label><input type="number" name="admin_salary" value="6000"></div>
                            <div class="form-group"><label>ЗП Сервис</label><input type="number" name="service_salary" value="4000"></div>
                        </div>
                        <div class="form-group"><label>Налоги ФОТ (%)</label><input type="number" name="payroll_tax" value="20"></div>
                        
                        <div class="two-col">
                            <div class="form-group"><label>Мат. Прием</label><input type="number" name="consultation_materials" value="5"></div>
                            <div class="form-group"><label>Мат. Операция</label><input type="number" name="operation_materials" value="250"></div>
                        </div>
                        <div class="form-group"><label>Мат. Диагностика</label><input type="number" name="diagnostics_materials" value="15"></div>
                    </div>

                    <div class="form-block">
                        <h3>6. Постоянные расходы</h3>
                        <div class="two-col">
                            <div class="form-group"><label>Аренда</label><input type="number" name="rent" value="0"></div>
                            <div class="form-group"><label>Коммуналка</label><input type="number" name="utilities" value="30000"></div>
                        </div>
                        <div class="two-col">
                            <div class="form-group"><label>Амортизация</label><input type="number" name="depreciation" value="400000"></div>
                            <div class="form-group"><label>IT / ПО</label><input type="number" name="it_systems" value="30000"></div>
                        </div>
                         <div class="two-col">
                             <div class="form-group"><label>Маркетинг</label><input type="number" name="marketing" value="0"></div>
                             <div class="form-group"><label>Страхование</label><input type="number" name="insurance" value="0"></div>
                         </div>
                        <div class="two-col">
                            <div class="form-group"><label>Прочие</label><input type="number" name="other_expenses" value="10000"></div>
                            <div class="form-group"><label>Налог на Прибыль (%)</label><input type="number" name="profit_tax" value="20"></div>
                        </div>
                    </div>

                    <button type="button" class="btn" onclick="handleCalculate()">Рассчитать</button>
                </form>
            </div>

            <div class="results-section">
                <div id="results"><p style="color: #718096; text-align: center; margin-top: 50px;">Нажмите "Рассчитать"</p></div>
            </div>
        </div>

        <div id="comparisonView" class="comparison-view hidden">
            <h2>Сравнение сценариев</h2>
            <p style="font-size: 13px; color: #718096;">Данные пересчитаны автоматически на основе сохраненных параметров.</p>
            <div id="comparisonContent"></div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const AppState = { scenarios: [], activeScenarioId: null };

        // --- CORE LOGIC ---
        function calculateMetrics(data) {
            const results = {};

            // 1. Time Calculations
            const working_days = data.days_per_week * data.weeks_per_year;
            
            // Capacity based on Doctor Effective Hours
            const doc_eff_hours_day = data.hours_per_day * (data.doctor_efficiency / 100);
            const doc_eff_hours_year = working_days * doc_eff_hours_day;
            const standard_hours_year = working_days * data.hours_per_day;

            // 2. Demand Flow (Pool Logic)
            const total_visits_demand = data.total_visits_per_year;
            const unique_patients = data.visit_coefficient > 0 ? Math.floor(total_visits_demand / data.visit_coefficient) : 0;

            const primary_demand = unique_patients;
            const ops_demand = Math.floor(unique_patients * (data.conversion_rate / 100));

            // Pool = Total - Primary - Ops
            let pool = total_visits_demand - primary_demand - ops_demand;
            if(pool < 0) pool = 0;

            const diag_demand = Math.floor(pool * (data.diagnostics_rate / 100));
            const followup_demand = pool - diag_demand;

            // 3. Capacity & Actuals
            // Doctor Capacity (Visits) = (Docs * EffHours) / (TimePerVisit + Prep)
            const visit_time_hr = (data.consultation_time + data.visit_prep_time) / 60;
            const doc_capacity = Math.floor(data.doctors * doc_eff_hours_year / visit_time_hr);
            
            // Doctors serve Primary + Followup (Consultation Load)
            const doc_load_demand = primary_demand + followup_demand;
            const doc_load_actual = Math.min(doc_capacity, doc_load_demand);
            const fulfillment_ratio = doc_load_demand > 0 ? doc_load_actual / doc_load_demand : 0;

            const primary_actual = Math.floor(primary_demand * fulfillment_ratio);
            const followup_actual = Math.floor(followup_demand * fulfillment_ratio);
            
            // Diag depends on pool but limited by overall fulfillment (simplification)
            const diag_actual = Math.floor(diag_demand * fulfillment_ratio);

            // Ops Capacity
            const op_time_hr = (data.operation_time + data.or_prep_time) / 60;
            const op_capacity = data.operating_rooms > 0 ? Math.floor(data.operating_rooms * standard_hours_year / op_time_hr) : 0;
            const ops_actual = Math.min(op_capacity, ops_demand);

            // Beds Capacity (Bed Days)
            const bed_days_available = data.beds * 365;
            const bed_capacity_days = bed_days_available; // NO DIVISION BY 3

            // Total Actual
            const total_visits_actual = primary_actual + followup_actual + diag_actual + ops_actual;
            const consultations_only_actual = primary_actual + followup_actual;

            // 4. Utilization Stats
            const doc_hours_used = consultations_only_actual * visit_time_hr;
            const doc_hours_avail = data.doctors * doc_eff_hours_year;
            const doc_util = doc_hours_avail > 0 ? (doc_hours_used / doc_hours_avail * 100) : 0;

            const op_hours_used = ops_actual * op_time_hr;
            const op_hours_avail = data.operating_rooms * standard_hours_year;
            const op_util = op_hours_avail > 0 ? (op_hours_used / op_hours_avail * 100) : 0;

            const beds_needed_days = ops_demand * 3; // Demand still consumes 3 days
            const beds_util = bed_days_available > 0 ? (beds_needed_days / bed_days_available * 100) : 0;

            // 5. Financials
            const rev_cons = primary_actual * data.consultation_price;
            const rev_foll = followup_actual * data.followup_price;
            const rev_diag = diag_actual * data.diagnostics_price;
            const rev_ops = ops_actual * data.operation_price;
            const revenue_total = rev_cons + rev_foll + rev_diag + rev_ops;

            // Expenses Breakdown
            const pay_docs = data.doctors * data.doctor_salary;
            const pay_nurse = data.nurses * data.nurse_salary;
            const pay_admin = data.admins * data.admin_salary;
            const pay_service = data.service_staff * data.service_salary;
            const pay_base = pay_docs + pay_nurse + pay_admin + pay_service;
            const pay_tax = pay_base * (data.payroll_tax / 100);
            const payroll_total = pay_base + pay_tax;

            const mat_cons = consultations_only_actual * data.consultation_materials;
            const mat_ops = ops_actual * data.operation_materials;
            const mat_diag = diag_actual * data.diagnostics_materials;
            const mat_total = mat_cons + mat_ops + mat_diag;

            const fix_rent = data.rent;
            const fix_util = data.utilities;
            const fix_depr = data.depreciation;
            const fix_it = data.it_systems;
            const fix_mark = data.marketing;
            const fix_ins = data.insurance;
            const fix_other = data.other_expenses;
            const fixed_total = fix_rent + fix_util + fix_depr + fix_it + fix_mark + fix_ins + fix_other;

            const expenses_total = payroll_total + mat_total + fixed_total;

            const expenses_excl_depr = expenses_total - data.depreciation;
            const ebitda = revenue_total - expenses_excl_depr;
            
            const ebit = ebitda - data.depreciation;
            const tax = ebit > 0 ? ebit * (data.profit_tax / 100) : 0;
            const net_profit = ebit - tax;

            // 6. ROI & Needs
            const roi_doc = data.doctors > 0 ? net_profit / data.doctors : 0;
            const roi_or = data.operating_rooms > 0 ? net_profit / data.operating_rooms : 0;

            // Needs calculated based on CONSULTATION load for doctors
            const doc_need = doc_capacity > 0 ? Math.ceil(data.doctors * (doc_load_demand / doc_capacity)) : 0;
            const or_need = op_capacity > 0 ? Math.ceil(data.operating_rooms * (ops_demand / op_capacity)) : 0;

            const var_cost_per_pat = unique_patients > 0 ? mat_total / unique_patients : 0; 
            const avg_rev_per_pat = unique_patients > 0 ? revenue_total / unique_patients : 0;
            const margin_per_pat = avg_rev_per_pat - var_cost_per_pat;
            const fixed_cash = payroll_total + fixed_total; 
            
            const be_patients = margin_per_pat > 0 ? fixed_cash / margin_per_pat : 0;
            const be_revenue = be_patients * avg_rev_per_pat;

            results.metrics = {
                visits: { 
                    total: total_visits_actual, 
                    consultations_only: consultations_only_actual,
                    month: total_visits_actual/12, 
                    day: working_days>0 ? total_visits_actual/working_days : 0 
                },
                capacity: { docs: doc_capacity, ops: op_capacity, beds: bed_capacity_days },
                utilization: { docs: doc_util, ops: op_util, beds: beds_util },
                financials: {
                    revenue: revenue_total,
                    expenses: expenses_total,
                    ebitda: ebitda,
                    net_profit: net_profit,
                    rev_details: { cons: rev_cons, foll: rev_foll, diag: rev_diag, ops: rev_ops },
                    exp_details: { 
                        payroll: { total: payroll_total, docs: pay_docs, nurses: pay_nurse, admins: pay_admin, service: pay_service, tax: pay_tax },
                        materials: { total: mat_total, cons: mat_cons, ops: mat_ops, diag: mat_diag },
                        fixed: { total: fixed_total, rent: fix_rent, util: fix_util, depr: fix_depr, it: fix_it, mark: fix_mark, ins: fix_ins, other: fix_other }
                    }
                },
                structure: { primary: primary_actual, followup: followup_actual, diag: diag_actual, ops: ops_actual, unique: primary_actual },
                averages: { rev_pat: avg_rev_per_pat, cost_pat: unique_patients>0?expenses_total/unique_patients:0 },
                breakeven: { patients: be_patients, revenue: be_revenue, safety: unique_patients>0 ? (unique_patients-be_patients)/unique_patients*100 : 0 },
                roi: { doc: roi_doc, or: roi_or },
                needs: { 
                    doc: { have: data.doctors, need: doc_need, diff: doc_need - data.doctors },
                    or: { have: data.operating_rooms, need: or_need, diff: or_need - data.operating_rooms }
                }
            };
            return results;
        }

        // --- RENDERERS ---
        function formatNum(n) { return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' '); }
        function formatMoney(n) { return '$' + formatNum(n); }
        function formatPct(n) { return n.toFixed(1) + '%'; }
        
        function getStatus(val) {
            if(val < 70) return {c:'status-low', t:'Недозагрузка'};
            if(val < 85) return {c:'status-optimal', t:'Оптимально'};
            if(val < 95) return {c:'status-high', t:'Высокая'};
            return {c:'status-critical', t:'Перегрузка'};
        }

        function renderResults(res, inputs) {
            const m = res.metrics;
            const div = document.getElementById('results');
            let h = '';

            // CALCULUS STRINGS
            const doc_calc_str = `(${inputs.doctors} вр. * ${inputs.doctor_efficiency}% * ${inputs.days_per_week} дн * ${inputs.weeks_per_year} нед * ${inputs.hours_per_day} ч) / ((${inputs.consultation_time}+${inputs.visit_prep_time})мин / 60)`;
            const op_calc_str = `(${inputs.operating_rooms} опер * ${inputs.days_per_week} дн * ${inputs.weeks_per_year} нед * ${inputs.hours_per_day} ч) / ((${inputs.operation_time}+${inputs.or_prep_time})мин / 60)`;
            const bed_calc_str = `(${inputs.beds} коек * 365 дней)`;

            // 1. PATIENT FLOW (MOVED TO TOP)
            h += '<div class="metric-group"><h2>ПАЦИЕНТОПОТОК</h2>';
             h += `<div class="metric-card"><h3>Структура</h3>
                    <div class="metric-row"><span class="metric-label">Консультация (1)</span><span class="metric-value">${formatNum(m.structure.primary)}</span></div>
                    <div class="metric-row"><span class="metric-label">Консультация (2)</span><span class="metric-value">${formatNum(m.structure.followup)}</span></div>
                    <div class="metric-row"><span class="metric-label">Диагностика</span><span class="metric-value">${formatNum(m.structure.diag)}</span></div>
                    <div class="metric-row"><span class="metric-label">Операции</span><span class="metric-value">${formatNum(m.structure.ops)}</span></div>
                    <div class="metric-row" style="margin-top: 10px; border-top: 2px solid #cbd5e0; padding-top: 8px;"><span class="metric-label" style="color:#1a202c;"><strong>ВСЕГО</strong></span><span class="metric-value">${formatNum(m.visits.total)}</span></div>
                  </div>`;
             h += `<div class="metric-card"><h3>Средние показатели</h3>
                    <div class="metric-row"><span class="metric-label">Выручка на пациента</span><span class="metric-value">${formatMoney(m.averages.rev_pat)}</span></div>
                    <div class="metric-row"><span class="metric-label">Расход на пациента</span><span class="metric-value">${formatMoney(m.averages.cost_pat)}</span></div>
                  </div>`;
            h += '</div>';

            // 2. OPERATIONAL
            h += '<div class="metric-group"><h2>ОПЕРАЦИОННЫЕ МЕТРИКИ</h2>';
            
            h += `<div class="metric-card"><h3>Пропускная способность операций</h3>
                    <div class="formula-block">
                        <div class="metric-row"><span class="metric-label">Пропускная способность операций</span><span class="metric-value">${formatNum(m.capacity.ops)}</span></div>
                        <div class="formula-hint">${op_calc_str}</div>
                    </div>
                    <div class="formula-block">
                        <div class="metric-row"><span class="metric-label">Пропускная способность (койко-дней)</span><span class="metric-value">${formatNum(m.capacity.beds)}</span></div>
                        <div class="formula-hint">${bed_calc_str}</div>
                    </div>
                    <div class="metric-row" style="margin-top:5px; border-top:1px dashed #eee; padding-top:5px;"><span class="metric-label">Факт операций</span><span class="metric-value">${formatNum(m.structure.ops)}</span></div>
                  </div>`;

            h += `<div class="metric-card"><h3>Пропускная способность консультаций</h3>
                    <div class="formula-block">
                        <div class="metric-row"><span class="metric-label">Мощность Врачей (визитов)</span><span class="metric-value">${formatNum(m.capacity.docs)}</span></div>
                        <div class="formula-hint">${doc_calc_str}</div>
                    </div>
                    <div class="metric-row" style="margin-top:5px; border-top:1px dashed #eee; padding-top:5px;"><span class="metric-label">Факт Консультаций (1+2)</span><span class="metric-value">${formatNum(m.visits.consultations_only)}</span></div>
                  </div>`;
            
            const uDoc = getStatus(m.utilization.docs);
            const uOr = getStatus(m.utilization.ops);
            const uBed = getStatus(m.utilization.beds);
            
            h += `<div class="metric-card"><h3>Загрузка Ресурсов</h3>
                    <div class="metric-row"><span class="metric-label">Врачи</span><span class="metric-value"><span class="status-indicator ${uDoc.c}"></span>${formatPct(m.utilization.docs)} (${uDoc.t})</span></div>
                    <div class="metric-row"><span class="metric-label">Операционные</span><span class="metric-value"><span class="status-indicator ${uOr.c}"></span>${formatPct(m.utilization.ops)} (${uOr.t})</span></div>
                    <div class="metric-row"><span class="metric-label">Койки</span><span class="metric-value"><span class="status-indicator ${uBed.c}"></span>${formatPct(m.utilization.beds)} (${uBed.t})</span></div>
                  </div>`;
            h += '</div>';

            // 3. FINANCIALS
            const ex = m.financials.exp_details;
            h += '<div class="metric-group"><h2>ФИНАНСОВЫЕ МЕТРИКИ</h2>';
            
            h += `<div class="metric-card"><h3>Выручка</h3>
                    <div class="metric-row" style="border-bottom:2px solid #edf2f7; margin-bottom:5px;"><span class="metric-label"><strong>ИТОГО</strong></span><span class="metric-value">${formatMoney(m.financials.revenue)}</span></div>
                    <ul class="detail-list">
                        <li><span>Консультации</span><span>${formatMoney(m.financials.rev_details.cons + m.financials.rev_details.foll)}</span></li>
                        <li><span>Диагностика</span><span>${formatMoney(m.financials.rev_details.diag)}</span></li>
                        <li><span>Операции</span><span>${formatMoney(m.financials.rev_details.ops)}</span></li>
                    </ul>
                  </div>`;
            
            h += `<div class="metric-card"><h3>Расходы</h3>
                    <div class="metric-row" style="border-bottom:2px solid #edf2f7; margin-bottom:5px;"><span class="metric-label"><strong>ИТОГО</strong></span><span class="metric-value">${formatMoney(m.financials.expenses)}</span></div>
                     
                     <ul class="detail-list">
                        <li><strong>ФОТ Персонала</strong><span>${formatMoney(ex.payroll.total)}</span></li>
                        <ul class="sub-list">
                            <li>Врачи: ${formatMoney(ex.payroll.docs)}</li>
                            <li>Медсестры: ${formatMoney(ex.payroll.nurses)}</li>
                            <li>Админы: ${formatMoney(ex.payroll.admins)}</li>
                            <li>Сервис: ${formatMoney(ex.payroll.service)}</li>
                            <li>Налоги ФОТ: ${formatMoney(ex.payroll.tax)}</li>
                        </ul>

                        <li><strong>Материалы</strong><span>${formatMoney(ex.materials.total)}</span></li>
                         <ul class="sub-list">
                            <li>На приемы: ${formatMoney(ex.materials.cons)}</li>
                            <li>На операции: ${formatMoney(ex.materials.ops)}</li>
                            <li>На диагностику: ${formatMoney(ex.materials.diag)}</li>
                        </ul>

                        <li><strong>Постоянные</strong><span>${formatMoney(ex.fixed.total)}</span></li>
                        <ul class="sub-list">
                            <li>Аренда: ${formatMoney(ex.fixed.rent)}</li>
                            <li>Коммуналка: ${formatMoney(ex.fixed.util)}</li>
                            <li>Амортизация: ${formatMoney(ex.fixed.depr)}</li>
                            <li>IT/ПО: ${formatMoney(ex.fixed.it)}</li>
                            <li>Маркетинг: ${formatMoney(ex.fixed.mark)}</li>
                            <li>Страхование: ${formatMoney(ex.fixed.ins)}</li>
                            <li>Прочее: ${formatMoney(ex.fixed.other)}</li>
                        </ul>
                    </ul>
                  </div>`;
            
            const ebitda_calc = `${formatMoney(m.financials.revenue)} - (${formatMoney(ex.payroll.total)} + ${formatMoney(ex.materials.total)} + ${formatMoney(ex.fixed.total - ex.fixed.depr)})`;
            
            h += `<div class="metric-card"><h3>Прибыльность</h3>
                    <div class="metric-row"><span class="metric-label">EBITDA</span><span class="metric-value">${formatMoney(m.financials.ebitda)}</span></div>
                    <div class="formula-hint">Расчет: Выручка - (ФОТ + Материалы + Постоянные без Аморт.)</div>
                    <div class="formula-hint">${ebitda_calc}</div>
                    
                    <div class="metric-row" style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                        <span class="metric-label"><strong>Чистая Прибыль</strong></span>
                        <span class="metric-value" style="color:${m.financials.net_profit>0?'#38a169':'#e53e3e'}">${formatMoney(m.financials.net_profit)}</span>
                    </div>
                  </div>`;
            
            h += `<div class="metric-card"><h3>ROI (в год)</h3>
                    <div class="metric-row"><span class="metric-label">На 1 врача</span><span class="metric-value">${formatMoney(m.roi.doc)}</span></div>
                    <div class="metric-row"><span class="metric-label">На 1 операционную</span><span class="metric-value">${formatMoney(m.roi.or)}</span></div>
                  </div>`;
            h += '</div>';

            // 4. RESOURCES
            h += '<div class="metric-group"><h2>РЕСУРСЫ</h2>';
            h += `<div class="metric-card"><h3>Дефицит / Профицит</h3>
                    <table class="resource-table">
                        <thead><tr><th>Ресурс</th><th>Есть</th><th>Нужно</th><th>Дефицит</th></tr></thead>
                        <tbody>
                            <tr><td>Врачи</td><td>${m.needs.doc.have}</td><td>${m.needs.doc.need}</td><td class="${m.needs.doc.diff>0?'deficit':'surplus'}">${m.needs.doc.diff}</td></tr>
                            <tr><td>Операционные</td><td>${m.needs.or.have}</td><td>${m.needs.or.need}</td><td class="${m.needs.or.diff>0?'deficit':'surplus'}">${m.needs.or.diff}</td></tr>
                        </tbody>
                    </table>
                  </div>`;
            h += '</div>';

            div.innerHTML = h;
        }

        function renderComparison() {
            const container = document.getElementById('comparisonContent');
            let html = '<table class="comparison-table"><thead><tr><th>Метрика</th>';
            
            const scenarios = AppState.scenarios;
            scenarios.forEach(s => html += `<th>${s.name}</th>`);
            html += '</tr></thead><tbody>';

            const addRow = (label, getter, formatter) => {
                html += `<tr><td>${label}</td>`;
                scenarios.forEach(s => html += `<td>${formatter(getter(s.results.metrics))}</td>`);
                html += `</tr>`;
            };

            html += '<tr class="group-header"><td colspan="3">ОПЕРАЦИОННЫЕ</td></tr>';
            addRow('Факт Консультаций (1+2)', m => m.visits.consultations_only, formatNum);
            addRow('Мощность Врачей', m => m.capacity.docs, formatNum);
            addRow('Мощность Оперблока (опер)', m => m.capacity.ops, formatNum);
            addRow('Мощность Коек (койко-дни)', m => m.capacity.beds, formatNum);
            addRow('Загрузка Врачей', m => m.utilization.docs, formatPct);
            addRow('Загрузка Оперблока', m => m.utilization.ops, formatPct);

            html += '<tr class="group-header"><td colspan="3">ФИНАНСЫ</td></tr>';
            addRow('Выручка', m => m.financials.revenue, formatMoney);
            addRow('Чистая Прибыль', m => m.financials.net_profit, formatMoney);
            addRow('EBITDA', m => m.financials.ebitda, formatMoney);
            addRow('ROI (Врач)', m => m.roi.doc, formatMoney);

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // --- APP CONTROLLER ---
        function handleCalculate() {
            const data = getFormData();
            const results = calculateMetrics(data);
            
            const active = AppState.scenarios.find(s => s.id === AppState.activeScenarioId);
            if(active) {
                active.parameters = data;
                active.results = results;
                saveData();
                renderResults(results, data);
            }
        }

        function switchView(id) {
            if (AppState.activeScenarioId && AppState.activeScenarioId !== 'compare') {
                const currentData = getFormData();
                const currentScen = AppState.scenarios.find(s => s.id === AppState.activeScenarioId);
                if(currentScen) currentScen.parameters = currentData;
            }

            AppState.activeScenarioId = id;
            saveData();

            if (id === 'compare') {
                document.getElementById('mainView').classList.add('hidden');
                document.getElementById('comparisonView').classList.remove('hidden');
                
                AppState.scenarios.forEach(s => {
                    s.results = calculateMetrics(s.parameters);
                });
                renderComparison();

            } else {
                document.getElementById('mainView').classList.remove('hidden');
                document.getElementById('comparisonView').classList.add('hidden');
                
                const next = AppState.scenarios.find(s => s.id === id);
                setFormData(next.parameters);
                
                if(next.results) renderResults(next.results, next.parameters);
                else document.getElementById('results').innerHTML = '<p style="text-align:center; margin-top:50px; color:#a0aec0">Нажмите Рассчитать</p>';
            }
            
            renderTabs();
        }

        function renderTabs() {
            const container = document.getElementById('scenarioTabs');
            container.innerHTML = '';
            
            AppState.scenarios.forEach(s => {
                const btn = document.createElement('div');
                btn.className = `tab ${s.id === AppState.activeScenarioId ? 'active' : ''}`;
                btn.innerText = s.name;
                btn.onclick = () => switchView(s.id);
                container.appendChild(btn);
            });

            const cmpBtn = document.createElement('div');
            cmpBtn.className = `tab compare-tab ${AppState.activeScenarioId === 'compare' ? 'active' : ''}`;
            cmpBtn.innerText = 'Сравнение';
            cmpBtn.onclick = () => switchView('compare');
            container.appendChild(cmpBtn);
        }

        function getFormData() {
            const form = document.getElementById('clinicForm');
            const data = {};
            new FormData(form).forEach((v, k) => data[k] = parseFloat(v) || 0);
            return data;
        }

        function setFormData(data) {
            const form = document.getElementById('clinicForm');
            Object.entries(data).forEach(([k, v]) => {
                if(form.elements[k]) form.elements[k].value = v;
            });
        }

        function saveData() { localStorage.setItem('sim_vBedDays', JSON.stringify(AppState)); }
        
        function init() {
            const saved = localStorage.getItem('sim_vBedDays');
            if(saved) {
                const parsed = JSON.parse(saved);
                AppState.scenarios = parsed.scenarios;
                AppState.activeScenarioId = parsed.activeScenarioId || 's1';
            } else {
                const defaults = getFormData();
                AppState.scenarios = [
                    { id: 's1', name: 'Сценарий 1', parameters: {...defaults}, results: null },
                    { id: 's2', name: 'Сценарий 2', parameters: {...defaults}, results: null }
                ];
                AppState.activeScenarioId = 's1';
            }
            
            switchView(AppState.activeScenarioId);
        }

        window.onload = init;
    </script>
</body>
</html>